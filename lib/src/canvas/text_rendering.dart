part of 'canvas.dart';

extension CanvasTextRendering on Canvas {
  // Method to draw characters (simple bitmap patterns)
  void _drawCharacter(
    img.Image target,
    String char,
    int x,
    int y,
    int width,
    int height,
    img.Color color,
  ) {
    // Use basic character patterns (5x7 pixels)
    final pattern = _getCharacterPattern(char);

    for (int py = 0; py < pattern.length && y + py < target.height; py++) {
      for (int px = 0; px < pattern[py].length && x + px < target.width; px++) {
        if (pattern[py][px] == 1 && x + px >= 0 && y + py >= 0) {
          target.setPixel(x + px, y + py, color);
        }
      }
    }
  }

  // Simple text drawing method
  void _drawSimpleText(
    img.Image target,
    String text,
    Offset offset,
    Color color,
    double fontSize,
  ) {
    final imgColor = img.ColorRgba8(
      color.red,
      color.green,
      color.blue,
      color.alpha,
    );

    // Determine pixel size based on character size
    final charWidth = (fontSize * 0.6).round();
    final charHeight = fontSize.round();

    var x = offset.dx.round();
    var y = offset.dy.round();

    for (int i = 0; i < text.length; i++) {
      final char = text[i];

      if (char == '\n') {
        // Line break processing
        x = offset.dx.round();
        y += (charHeight * 1.2).round();
        continue;
      }

      // Draw each character with simple pixel patterns
      _drawCharacter(target, char, x, y, charWidth, charHeight, imgColor);

      x += charWidth;

      // Line break when going off screen
      if (x + charWidth > target.width) {
        x = offset.dx.round();
        y += (charHeight * 1.2).round();
      }
    }
  }

  // Get character patterns (5x7 pixel basic patterns)
  List<List<int>> _getCharacterPattern(String char) {
    switch (char) {
      case 'A':
      case 'a':
        return [
          [0, 1, 1, 1, 0],
          [1, 0, 0, 0, 1],
          [1, 0, 0, 0, 1],
          [1, 1, 1, 1, 1],
          [1, 0, 0, 0, 1],
          [1, 0, 0, 0, 1],
          [0, 0, 0, 0, 0],
        ];
      case 'B':
      case 'b':
        return [
          [1, 1, 1, 1, 0],
          [1, 0, 0, 0, 1],
          [1, 0, 0, 0, 1],
          [1, 1, 1, 1, 0],
          [1, 0, 0, 0, 1],
          [1, 1, 1, 1, 0],
          [0, 0, 0, 0, 0],
        ];
      case 'C':
      case 'c':
        return [
          [0, 1, 1, 1, 0],
          [1, 0, 0, 0, 1],
          [1, 0, 0, 0, 0],
          [1, 0, 0, 0, 0],
          [1, 0, 0, 0, 1],
          [0, 1, 1, 1, 0],
          [0, 0, 0, 0, 0],
        ];
      case 'D':
      case 'd':
        return [
          [1, 1, 1, 1, 0],
          [1, 0, 0, 0, 1],
          [1, 0, 0, 0, 1],
          [1, 0, 0, 0, 1],
          [1, 0, 0, 0, 1],
          [1, 1, 1, 1, 0],
          [0, 0, 0, 0, 0],
        ];
      case 'E':
      case 'e':
        return [
          [1, 1, 1, 1, 1],
          [1, 0, 0, 0, 0],
          [1, 0, 0, 0, 0],
          [1, 1, 1, 1, 0],
          [1, 0, 0, 0, 0],
          [1, 1, 1, 1, 1],
          [0, 0, 0, 0, 0],
        ];
      case 'F':
      case 'f':
        return [
          [1, 1, 1, 1, 1],
          [1, 0, 0, 0, 0],
          [1, 0, 0, 0, 0],
          [1, 1, 1, 1, 0],
          [1, 0, 0, 0, 0],
          [1, 0, 0, 0, 0],
          [0, 0, 0, 0, 0],
        ];
      case 'G':
      case 'g':
        return [
          [0, 1, 1, 1, 0],
          [1, 0, 0, 0, 1],
          [1, 0, 0, 0, 0],
          [1, 0, 1, 1, 1],
          [1, 0, 0, 0, 1],
          [0, 1, 1, 1, 0],
          [0, 0, 0, 0, 0],
        ];
      case 'H':
      case 'h':
        return [
          [1, 0, 0, 0, 1],
          [1, 0, 0, 0, 1],
          [1, 0, 0, 0, 1],
          [1, 1, 1, 1, 1],
          [1, 0, 0, 0, 1],
          [1, 0, 0, 0, 1],
          [0, 0, 0, 0, 0],
        ];
      case 'I':
      case 'i':
        return [
          [1, 1, 1, 1, 1],
          [0, 0, 1, 0, 0],
          [0, 0, 1, 0, 0],
          [0, 0, 1, 0, 0],
          [0, 0, 1, 0, 0],
          [1, 1, 1, 1, 1],
          [0, 0, 0, 0, 0],
        ];
      case 'J':
      case 'j':
        return [
          [1, 1, 1, 1, 1],
          [0, 0, 0, 1, 0],
          [0, 0, 0, 1, 0],
          [0, 0, 0, 1, 0],
          [1, 0, 0, 1, 0],
          [0, 1, 1, 0, 0],
          [0, 0, 0, 0, 0],
        ];
      case 'K':
      case 'k':
        return [
          [1, 0, 0, 0, 1],
          [1, 0, 0, 1, 0],
          [1, 0, 1, 0, 0],
          [1, 1, 0, 0, 0],
          [1, 0, 1, 0, 0],
          [1, 0, 0, 1, 0],
          [0, 0, 0, 0, 0],
        ];
      case 'L':
      case 'l':
        return [
          [1, 0, 0, 0, 0],
          [1, 0, 0, 0, 0],
          [1, 0, 0, 0, 0],
          [1, 0, 0, 0, 0],
          [1, 0, 0, 0, 0],
          [1, 1, 1, 1, 1],
          [0, 0, 0, 0, 0],
        ];
      case 'M':
      case 'm':
        return [
          [1, 0, 0, 0, 1],
          [1, 1, 0, 1, 1],
          [1, 0, 1, 0, 1],
          [1, 0, 0, 0, 1],
          [1, 0, 0, 0, 1],
          [1, 0, 0, 0, 1],
          [0, 0, 0, 0, 0],
        ];
      case 'N':
      case 'n':
        return [
          [1, 0, 0, 0, 1],
          [1, 1, 0, 0, 1],
          [1, 0, 1, 0, 1],
          [1, 0, 0, 1, 1],
          [1, 0, 0, 0, 1],
          [1, 0, 0, 0, 1],
          [0, 0, 0, 0, 0],
        ];
      case 'O':
      case 'o':
        return [
          [0, 1, 1, 1, 0],
          [1, 0, 0, 0, 1],
          [1, 0, 0, 0, 1],
          [1, 0, 0, 0, 1],
          [1, 0, 0, 0, 1],
          [0, 1, 1, 1, 0],
          [0, 0, 0, 0, 0],
        ];
      case 'P':
      case 'p':
        return [
          [1, 1, 1, 1, 0],
          [1, 0, 0, 0, 1],
          [1, 0, 0, 0, 1],
          [1, 1, 1, 1, 0],
          [1, 0, 0, 0, 0],
          [1, 0, 0, 0, 0],
          [0, 0, 0, 0, 0],
        ];
      case 'Q':
      case 'q':
        return [
          [0, 1, 1, 1, 0],
          [1, 0, 0, 0, 1],
          [1, 0, 0, 0, 1],
          [1, 0, 1, 0, 1],
          [1, 0, 0, 1, 1],
          [0, 1, 1, 1, 1],
          [0, 0, 0, 0, 0],
        ];
      case 'R':
      case 'r':
        return [
          [1, 1, 1, 1, 0],
          [1, 0, 0, 0, 1],
          [1, 0, 0, 0, 1],
          [1, 1, 1, 1, 0],
          [1, 0, 1, 0, 0],
          [1, 0, 0, 1, 0],
          [0, 0, 0, 0, 0],
        ];
      case 'S':
      case 's':
        return [
          [0, 1, 1, 1, 1],
          [1, 0, 0, 0, 0],
          [1, 0, 0, 0, 0],
          [0, 1, 1, 1, 0],
          [0, 0, 0, 0, 1],
          [1, 1, 1, 1, 0],
          [0, 0, 0, 0, 0],
        ];
      case 'T':
      case 't':
        return [
          [1, 1, 1, 1, 1],
          [0, 0, 1, 0, 0],
          [0, 0, 1, 0, 0],
          [0, 0, 1, 0, 0],
          [0, 0, 1, 0, 0],
          [0, 0, 1, 0, 0],
          [0, 0, 0, 0, 0],
        ];
      case 'U':
      case 'u':
        return [
          [1, 0, 0, 0, 1],
          [1, 0, 0, 0, 1],
          [1, 0, 0, 0, 1],
          [1, 0, 0, 0, 1],
          [1, 0, 0, 0, 1],
          [0, 1, 1, 1, 0],
          [0, 0, 0, 0, 0],
        ];
      case 'V':
      case 'v':
        return [
          [1, 0, 0, 0, 1],
          [1, 0, 0, 0, 1],
          [1, 0, 0, 0, 1],
          [1, 0, 0, 0, 1],
          [0, 1, 0, 1, 0],
          [0, 0, 1, 0, 0],
          [0, 0, 0, 0, 0],
        ];
      case 'W':
      case 'w':
        return [
          [1, 0, 0, 0, 1],
          [1, 0, 0, 0, 1],
          [1, 0, 0, 0, 1],
          [1, 0, 1, 0, 1],
          [1, 1, 0, 1, 1],
          [1, 0, 0, 0, 1],
          [0, 0, 0, 0, 0],
        ];
      case 'X':
      case 'x':
        return [
          [1, 0, 0, 0, 1],
          [0, 1, 0, 1, 0],
          [0, 0, 1, 0, 0],
          [0, 0, 1, 0, 0],
          [0, 1, 0, 1, 0],
          [1, 0, 0, 0, 1],
          [0, 0, 0, 0, 0],
        ];
      case 'Y':
      case 'y':
        return [
          [1, 0, 0, 0, 1],
          [0, 1, 0, 1, 0],
          [0, 0, 1, 0, 0],
          [0, 0, 1, 0, 0],
          [0, 0, 1, 0, 0],
          [0, 0, 1, 0, 0],
          [0, 0, 0, 0, 0],
        ];
      case 'Z':
      case 'z':
        return [
          [1, 1, 1, 1, 1],
          [0, 0, 0, 1, 0],
          [0, 0, 1, 0, 0],
          [0, 1, 0, 0, 0],
          [1, 0, 0, 0, 0],
          [1, 1, 1, 1, 1],
          [0, 0, 0, 0, 0],
        ];
      case '0':
        return [
          [0, 1, 1, 1, 0],
          [1, 0, 0, 1, 1],
          [1, 0, 1, 0, 1],
          [1, 1, 0, 0, 1],
          [1, 0, 0, 0, 1],
          [0, 1, 1, 1, 0],
          [0, 0, 0, 0, 0],
        ];
      case '1':
        return [
          [0, 0, 1, 0, 0],
          [0, 1, 1, 0, 0],
          [0, 0, 1, 0, 0],
          [0, 0, 1, 0, 0],
          [0, 0, 1, 0, 0],
          [0, 1, 1, 1, 0],
          [0, 0, 0, 0, 0],
        ];
      case '2':
        return [
          [0, 1, 1, 1, 0],
          [1, 0, 0, 0, 1],
          [0, 0, 0, 1, 0],
          [0, 0, 1, 0, 0],
          [0, 1, 0, 0, 0],
          [1, 1, 1, 1, 1],
          [0, 0, 0, 0, 0],
        ];
      case '3':
        return [
          [0, 1, 1, 1, 0],
          [1, 0, 0, 0, 1],
          [0, 0, 1, 1, 0],
          [0, 0, 0, 0, 1],
          [1, 0, 0, 0, 1],
          [0, 1, 1, 1, 0],
          [0, 0, 0, 0, 0],
        ];
      case '4':
        return [
          [0, 0, 0, 1, 0],
          [0, 0, 1, 1, 0],
          [0, 1, 0, 1, 0],
          [1, 0, 0, 1, 0],
          [1, 1, 1, 1, 1],
          [0, 0, 0, 1, 0],
          [0, 0, 0, 0, 0],
        ];
      case '5':
        return [
          [1, 1, 1, 1, 1],
          [1, 0, 0, 0, 0],
          [1, 1, 1, 1, 0],
          [0, 0, 0, 0, 1],
          [1, 0, 0, 0, 1],
          [0, 1, 1, 1, 0],
          [0, 0, 0, 0, 0],
        ];
      case '6':
        return [
          [0, 1, 1, 1, 0],
          [1, 0, 0, 0, 0],
          [1, 1, 1, 1, 0],
          [1, 0, 0, 0, 1],
          [1, 0, 0, 0, 1],
          [0, 1, 1, 1, 0],
          [0, 0, 0, 0, 0],
        ];
      case '7':
        return [
          [1, 1, 1, 1, 1],
          [0, 0, 0, 0, 1],
          [0, 0, 0, 1, 0],
          [0, 0, 1, 0, 0],
          [0, 1, 0, 0, 0],
          [1, 0, 0, 0, 0],
          [0, 0, 0, 0, 0],
        ];
      case '8':
        return [
          [0, 1, 1, 1, 0],
          [1, 0, 0, 0, 1],
          [0, 1, 1, 1, 0],
          [1, 0, 0, 0, 1],
          [1, 0, 0, 0, 1],
          [0, 1, 1, 1, 0],
          [0, 0, 0, 0, 0],
        ];
      case '9':
        return [
          [0, 1, 1, 1, 0],
          [1, 0, 0, 0, 1],
          [1, 0, 0, 0, 1],
          [0, 1, 1, 1, 1],
          [0, 0, 0, 0, 1],
          [0, 1, 1, 1, 0],
          [0, 0, 0, 0, 0],
        ];
      case ' ':
        return [
          [0, 0, 0, 0, 0],
          [0, 0, 0, 0, 0],
          [0, 0, 0, 0, 0],
          [0, 0, 0, 0, 0],
          [0, 0, 0, 0, 0],
          [0, 0, 0, 0, 0],
          [0, 0, 0, 0, 0],
        ];
      case '!':
        return [
          [0, 0, 1, 0, 0],
          [0, 0, 1, 0, 0],
          [0, 0, 1, 0, 0],
          [0, 0, 1, 0, 0],
          [0, 0, 0, 0, 0],
          [0, 0, 1, 0, 0],
          [0, 0, 0, 0, 0],
        ];
      case '?':
        return [
          [0, 1, 1, 1, 0],
          [1, 0, 0, 0, 1],
          [0, 0, 0, 1, 0],
          [0, 0, 1, 0, 0],
          [0, 0, 0, 0, 0],
          [0, 0, 1, 0, 0],
          [0, 0, 0, 0, 0],
        ];
      case '.':
        return [
          [0, 0, 0, 0, 0],
          [0, 0, 0, 0, 0],
          [0, 0, 0, 0, 0],
          [0, 0, 0, 0, 0],
          [0, 0, 0, 0, 0],
          [0, 0, 1, 0, 0],
          [0, 0, 0, 0, 0],
        ];
      case ',':
        return [
          [0, 0, 0, 0, 0],
          [0, 0, 0, 0, 0],
          [0, 0, 0, 0, 0],
          [0, 0, 0, 0, 0],
          [0, 0, 1, 0, 0],
          [0, 1, 0, 0, 0],
          [0, 0, 0, 0, 0],
        ];
      case ':':
        return [
          [0, 0, 0, 0, 0],
          [0, 0, 1, 0, 0],
          [0, 0, 0, 0, 0],
          [0, 0, 0, 0, 0],
          [0, 0, 1, 0, 0],
          [0, 0, 0, 0, 0],
          [0, 0, 0, 0, 0],
        ];
      // Basic Japanese character support
      case 'こ':
        return [
          [1, 1, 1, 1, 1],
          [0, 0, 1, 0, 0],
          [1, 1, 1, 1, 1],
          [0, 1, 0, 1, 0],
          [1, 1, 0, 1, 1],
          [0, 0, 0, 0, 0],
          [0, 0, 0, 0, 0],
        ];
      case 'ん':
        return [
          [0, 1, 1, 1, 0],
          [1, 0, 0, 0, 1],
          [0, 1, 1, 1, 0],
          [0, 1, 0, 0, 0],
          [1, 0, 1, 1, 1],
          [0, 0, 0, 0, 0],
          [0, 0, 0, 0, 0],
        ];
      case 'に':
        return [
          [1, 1, 1, 1, 1],
          [0, 0, 1, 0, 0],
          [0, 0, 1, 0, 0],
          [1, 1, 1, 1, 1],
          [0, 0, 1, 0, 0],
          [0, 0, 0, 0, 0],
          [0, 0, 0, 0, 0],
        ];
      case 'ち':
        return [
          [0, 0, 1, 0, 0],
          [1, 1, 1, 1, 1],
          [0, 0, 1, 0, 0],
          [0, 1, 1, 1, 0],
          [1, 0, 1, 0, 1],
          [0, 0, 0, 0, 0],
          [0, 0, 0, 0, 0],
        ];
      case 'は':
        return [
          [1, 0, 1, 0, 1],
          [1, 0, 1, 0, 1],
          [1, 1, 1, 1, 1],
          [1, 0, 1, 0, 1],
          [1, 0, 1, 0, 1],
          [0, 0, 0, 0, 0],
          [0, 0, 0, 0, 0],
        ];
      case '世':
        return [
          [0, 0, 1, 0, 0],
          [1, 1, 1, 1, 1],
          [0, 0, 1, 0, 0],
          [1, 1, 1, 1, 1],
          [0, 0, 1, 0, 0],
          [1, 1, 1, 1, 1],
          [0, 0, 0, 0, 0],
        ];
      case '界':
        return [
          [1, 1, 1, 1, 1],
          [1, 0, 1, 0, 1],
          [1, 1, 1, 1, 1],
          [1, 0, 1, 0, 1],
          [1, 0, 1, 0, 1],
          [1, 1, 1, 1, 1],
          [0, 0, 0, 0, 0],
        ];
      default:
        // Display as rectangle for unknown characters
        return [
          [1, 1, 1, 1, 1],
          [1, 0, 0, 0, 1],
          [1, 0, 1, 0, 1],
          [1, 0, 0, 0, 1],
          [1, 0, 0, 0, 1],
          [1, 1, 1, 1, 1],
          [0, 0, 0, 0, 0],
        ];
    }
  }

  void _renderParagraph(Paragraph paragraph, Offset offset) {
    if (_image == null) return;

    final target = _image.image;
    final text = paragraph.text;

    // Get color and font size from text style
    final textStyle = paragraph.textStyle;
    final color = textStyle.color ?? const Color(0xFF000000);
    final fontSize = textStyle.fontSize ?? 14.0;

    // Basic bitmap font drawing
    _drawSimpleText(target, text, offset, color, fontSize);
  }
}
